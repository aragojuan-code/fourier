<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Epiciclos – Corazón</title>
<style>
  :root{
    --bg:#0f141b; --panel:#121a23; --ink:#e6eef7; --muted:#9fb3c9; --accent:#6ab0ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  canvas{position:fixed;inset:0;width:100vw;height:100vh;display:block;background:#000}
  .ui{position:fixed;left:12px;top:12px;display:grid;gap:10px;background:var(--panel);
      border:1px solid rgba(230,238,247,.1);padding:12px;border-radius:12px;max-width:310px}
  .row{display:flex;align-items:center;gap:8px}
  .lab{color:var(--muted);font-size:12px}
  .title{font-weight:700}
  input[type="range"]{width:160px}
  select,button{background:#101722;border:1px solid rgba(230,238,247,.12);color:var(--ink);padding:8px 10px;border-radius:10px}
  button.primary{background:var(--accent);color:#06121e;border:0}
  a.small{color:var(--muted);font-size:12px;text-decoration:none}
</style>
</head>
<body>
<canvas id="cv"></canvas>

<div class="ui">
  <div class="title">Epiciclos → Figura</div>
  <div class="row">
    <span class="lab">Figura</span>
    <select id="shape">
      <option value="heart" selected>Corazón</option>
      <option value="star">Estrella (5 puntas)</option>
      <option value="infinity">Infinito (lemniscata)</option>
      <option value="circle">Círculo</option>
    </select>
    <button id="reset">Reset</button>
  </div>

  <div class="row">
    <span class="lab">Armónicos</span>
    <input id="harm" type="range" min="8" max="256" step="8" value="96">
    <span id="harmVal" class="lab">96</span>
  </div>
  <div class="row">
    <span class="lab">Velocidad</span>
    <input id="speed" type="range" min="0.25" max="4" step="0.25" value="1">
    <span id="spdVal" class="lab">1×</span>
  </div>
  <div class="row">
    <label class="lab"><input id="showCircles" type="checkbox" checked> Mostrar círculos</label>
  </div>
  <div class="row" style="gap:10px">
    <button id="pause">Pausa</button>
    <button id="drawOnly">Solo línea</button>
  </div>
  <a class="small" href="#" id="savePNG">Guardar PNG</a>
</div>

<script>
const cvs = document.getElementById('cv');
const ctx = cvs.getContext('2d');
const dpi = devicePixelRatio||1;
let W=0,H=0;

const shapeSel = document.getElementById('shape');
const harm = document.getElementById('harm'); const harmVal = document.getElementById('harmVal');
const speed = document.getElementById('speed'); const spdVal = document.getElementById('spdVal');
const showCircles = document.getElementById('showCircles');
const pauseBtn = document.getElementById('pause');
const drawOnlyBtn = document.getElementById('drawOnly');
const resetBtn = document.getElementById('reset');
const savePNGBtn = document.getElementById('savePNG');

let points=[], coeffs=[], order=[];
let t=0, running=true, onlyLine=false;

function resize(){
  W = Math.floor(innerWidth*dpi); H = Math.floor(innerHeight*dpi);
  cvs.width=W; cvs.height=H;
}
resize(); addEventListener('resize', resize);

/* ---------- Figuras paramétricas ---------- */
function sampleHeart(N){
  // Corazón clásico: escalado y centrado
  // x = 16 sin^3 t
  // y = 13 cos t − 5 cos 2t − 2 cos 3t − cos 4t
  const pts=[];
  const s = Math.min(W,H)*0.03; // escala
  for(let i=0;i<N;i++){
    const t = i/N * 2*Math.PI;
    const x = 16*Math.pow(Math.sin(t),3);
    const y = 13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
    pts.push({x: W/2 + x*s, y: H/2 - y*s});
  }
  return pts;
}
function sampleStar(N){
  const pts=[];
  const R = Math.min(W,H)*0.33, r = R*0.4, cx=W/2, cy=H/2;
  for(let i=0;i<N;i++){
    const a = i/N*2*Math.PI;
    const k = (i% (N/5) < (N/10)) ? R : r;
    pts.push({x:cx + k*Math.cos(a*2.5), y:cy + k*Math.sin(a*2.5)});
  }
  return pts;
}
function sampleInfinity(N){
  const a = Math.min(W,H)*0.22, cx=W/2, cy=H/2;
  const pts=[];
  for(let i=0;i<N;i++){
    const t = i/N*2*Math.PI;
    const denom = 1+Math.sin(t)*Math.sin(t);
    const x = a*Math.cos(t)/denom;
    const y = a*Math.sin(t)*Math.cos(t)/denom;
    pts.push({x:cx+x, y:cy+y});
  }
  return pts;
}
function sampleCircle(N){
  const pts=[], R=Math.min(W,H)*0.33, cx=W/2, cy=H/2;
  for(let i=0;i<N;i++){
    const a = i/N*2*Math.PI;
    pts.push({x:cx+R*Math.cos(a), y:cy+R*Math.sin(a)});
  }
  return pts;
}

/* ---------- Utilidades ---------- */
function dft(points){
  const N=points.length;
  let cx=0,cy=0; for(const p of points){cx+=p.x; cy+=p.y} cx/=N; cy/=N;
  const z=points.map(p=>({re:p.x-cx, im:p.y-cy}));
  const C=[];
  for(let k=-Math.floor(N/2); k<=Math.floor(N/2); k++){
    let re=0,im=0;
    for(let n=0;n<N;n++){
      const ang=-2*Math.PI*k*n/N;
      re += z[n].re*Math.cos(ang) - z[n].im*Math.sin(ang);
      im += z[n].re*Math.sin(ang) + z[n].im*Math.cos(ang);
    }
    re/=N; im/=N;
    C.push({k, amp: Math.hypot(re,im), phase: Math.atan2(im,re), cx, cy});
  }
  return C;
}
function rebuildOrder(){
  order = [...coeffs].sort((a,b)=> b.amp - a.amp);
}

/* ---------- Animación ---------- */
function drawFrame(dt){
  if(running){ t += dt * parseFloat(speed.value); }
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);

  let x = coeffs[0]?.cx || W/2, y = coeffs[0]?.cy || H/2;
  const chosen = order.slice(0, parseInt(harm.value,10));

  if(!onlyLine && showCircles.checked){
    ctx.lineWidth=1*dpi; ctx.strokeStyle='rgba(255,255,255,.25)';
  }
  for(const c of chosen){
    const ang = 2*Math.PI*c.k*(t%1) + c.phase;
    const vx = c.amp*Math.cos(ang), vy = c.amp*Math.sin(ang);
    if(!onlyLine && showCircles.checked){
      ctx.beginPath(); ctx.arc(x,y,c.amp,0,Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+vx,y+vy); ctx.stroke();
    }
    x += vx; y += vy;
  }

  // punto final y trazo
  ctx.fillStyle='#e6eef7';
  ctx.beginPath(); ctx.arc(x,y,2.5*dpi,0,Math.PI*2); ctx.fill();

  ctx.lineWidth=2*dpi; ctx.strokeStyle='#e6eef7';
  // Dibujar la curva "verdadera" una vez (opcionalmente para comparar).
  // Aquí omitimos para dejar solo lo reconstruido por epiciclos.
}

let last=performance.now();
function loop(now){
  const dt = Math.min(0.05, (now-last)/1000); last=now;
  drawFrame(dt);
  requestAnimationFrame(loop);
}

/* ---------- Eventos UI ---------- */
function buildShape(){
  const N = 1024; // puntos de muestreo para calidad de DFT
  const mode = shapeSel.value;
  if(mode==='heart') points = sampleHeart(N);
  else if(mode==='star') points = sampleStar(N);
  else if(mode==='infinity') points = sampleInfinity(N);
  else points = sampleCircle(N);
  coeffs = dft(points);
  rebuildOrder();
  t = 0;
}
buildShape();
requestAnimationFrame(loop);

harm.addEventListener('input', ()=>{harmVal.textContent=harm.value});
speed.addEventListener('input', ()=>{spdVal.textContent=speed.value+'×'});
shapeSel.addEventListener('change', ()=> buildShape());
resetBtn.addEventListener('click', ()=> { t=0; });
pauseBtn.addEventListener('click', ()=> { running=!running; pauseBtn.textContent = running?'Pausa':'Reanudar'; });
drawOnlyBtn.addEventListener('click', ()=> { onlyLine=!onlyLine; drawOnlyBtn.textContent = onlyLine?'Círculos + línea':'Solo línea'; });
savePNGBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  const url = cvs.toDataURL('image/png');
  const a = document.createElement('a');
  a.href=url; a.download='epiciclos.png'; a.click();
});
</script>
</body>
</html>
