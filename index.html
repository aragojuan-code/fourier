<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
<title>Epiciclos ‚Äì M√≥vil Minimal</title>
<style>
  :root{
    --bg:#0f141b; --panel:#121a23; --ink:#e6eef7; --muted:#9fb3c9; --accent:#6ab0ff;
    --line:#e6eef7; --grid:rgba(230,238,247,.12); --shadow:rgba(0,0,0,.35);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .main{position:fixed; inset:0; height:100dvh; overflow:hidden; background:#000}
  canvas{position:absolute; inset:0; width:100%; height:100%; display:block; background:#000; touch-action:none}

  /* HUD (esquina superior) */
  .hud{
    position:absolute; left:12px; top:12px; display:flex; gap:8px; z-index:5;
  }
  .chip{
    display:flex; align-items:center; justify-content:center;
    width:40px; height:40px; border-radius:12px;
    background:rgba(16,23,34,.9); border:1px solid rgba(230,238,247,.1);
    box-shadow:0 4px 14px var(--shadow); font-size:18px; cursor:pointer;
  }
  .chip:active{transform:scale(.98)}

  /* FAB play/pause */
  .fab{
    position:absolute; right:14px; bottom:88px; z-index:5;
    width:64px; height:64px; border-radius:22px; font-size:26px;
    display:flex; align-items:center; justify-content:center; cursor:pointer;
    background:var(--accent); color:#06121e; border:none; box-shadow:0 10px 30px var(--shadow);
  }

  /* Bottom sheet */
  .sheet{
    position:absolute; left:0; right:0; bottom:0; z-index:6;
    background:var(--panel); border-top:1px solid var(--grid);
    box-shadow:0 -12px 30px var(--shadow);
    border-top-left-radius:16px; border-top-right-radius:16px;
    touch-action:none;
  }
  .sheet .handle{width:44px; height:5px; background:rgba(230,238,247,.25); border-radius:999px; margin:10px auto}
  .sheet .row{display:flex; align-items:center; gap:10px; padding:10px 14px; flex-wrap:wrap}
  .sheet .lab{color:var(--muted); font-size:12px}
  .sheet button, .sheet select{
    background:#101722; border:1px solid rgba(230,238,247,.12); color:var(--ink);
    padding:10px 12px; border-radius:12px;
  }
  .icon{width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center}
  .seg{display:flex; gap:8px}
  .seg button{min-width:40px}
  .slider{appearance:none; width:100%; height:32px; background:transparent}
  .slider::-webkit-slider-runnable-track{height:4px;background:rgba(230,238,247,.2);border-radius:4px}
  .slider::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:10px;background:#fff;margin-top:-8px;box-shadow:0 2px 8px var(--shadow)}
  .tools{display:grid; grid-template-columns: 1fr 1fr; gap:8px; padding:0 14px 14px}
  .palette{display:flex; gap:8px}
  .dot{width:28px; height:28px; border-radius:50%; border:1px solid rgba(230,238,247,.2); cursor:pointer}
</style>
</head>
<body>
<div class="main">
  <canvas id="cv"></canvas>

  <!-- HUD (sin n√∫meros) -->
  <div class="hud">
    <div class="chip" id="hudCircles" title="C√≠rculos">‚óè</div>
    <div class="chip" id="hudSpeed"   title="Velocidad">üê¢</div>
    <div class="chip" id="hudTrail"   title="Trayectoria">üåÄ</div>
    <div class="chip" id="hudColor"   title="Color">üé®</div>
  </div>

  <!-- FAB -->
  <button class="fab" id="fab">‚ñ∂Ô∏é</button>

  <!-- Bottom sheet -->
  <div class="sheet" id="sheet" style="height:92px">
    <div class="handle"></div>

    <!-- Colapsado: chips -->
    <div class="row" id="collapsedRow">
      <div class="seg">
        <button class="icon" id="cDec">‚àí</button>
        <button class="icon" id="cInc">+</button>
      </div>
      <button class="icon" id="speedPreset">‚ö°</button>
      <button class="icon" id="colorNow">üé®</button>
      <button class="icon" id="moreBtn">‚ãØ</button>
    </div>

    <!-- Expandido: controles -->
    <div id="expanded" style="display:none">
      <div class="row"><span class="lab">C√≠rculos</span>
        <input id="circles" class="slider" type="range" min="1" max="16" step="1" value="8">
      </div>

      <div class="row"><span class="lab">Velocidad</span>
        <div class="seg">
          <button data-v="0.05">üê¢</button>
          <button data-v="0.10">üôÇ</button>
          <button data-v="0.25">üêá</button>
          <button data-v="0.50">üöÄ</button>
        </div>
        <input id="speed" class="slider" type="range" min="0.02" max="1" step="0.02" value="0.10">
      </div>

      <div class="row"><span class="lab">Zoom</span>
        <input id="zoom" class="slider" type="range" min="0.5" max="3" step="0.05" value="1">
        <button id="recenter">Centrar</button>
      </div>

      <div class="row"><span class="lab">Trayectoria</span>
        <label><input id="showTrace" type="checkbox" checked> Mostrar</label>
        <input id="trail" class="slider" type="range" min="200" max="4000" step="100" value="1500">
      </div>

      <div class="row"><span class="lab">C√≠rculos visibles</span>
        <label><input id="showCircles" type="checkbox" checked> Mostrar</label>
      </div>

      <div class="row"><span class="lab">Color</span>
        <div class="palette" id="palette">
          <div class="dot" style="background:#e6eef7" data-c="#e6eef7"></div>
          <div class="dot" style="background:#ff9ecb" data-c="#ff9ecb"></div>
          <div class="dot" style="background:#ffd27a" data-c="#ffd27a"></div>
          <div class="dot" style="background:#9cffb1" data-c="#9cffb1"></div>
          <div class="dot" style="background:#9ecbff" data-c="#9ecbff"></div>
        </div>
        <label><input id="autoColor" type="checkbox"> Auto</label>
        <button id="changeColor">Cambiar ahora</button>
      </div>

      <div class="row"><span class="lab">Figura</span>
        <select id="shape">
          <option value="heart" selected>Coraz√≥n</option>
          <option value="star">Estrella 5</option>
          <option value="triangle">Tri√°ngulo</option>
          <option value="square">Cuadrado</option>
          <option value="pentagon">Pent√°gono</option>
          <option value="hexagon">Hex√°gono</option>
          <option value="infinity">Infinito</option>
          <option value="circle">C√≠rculo</option>
          <option value="batman">Batman</option>
        </select>
      </div>

      <div class="tools">
        <button id="savePNG">Guardar PNG</button>
        <button id="closeSheet">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Estado ===== */
const cvs = document.getElementById('cv');
const ctx = cvs.getContext('2d');
const dpi = devicePixelRatio||1;

let W=0,H=0;
let points=[], coeffs=[], order=[];
let t=0, running=false, onlyLine=false;
let showCircles=true, showTrace=true;
let trace=[], traceMax=1500;
let zoom=1, centerOffset={x:0,y:0};
let currentColor = '#e6eef7';
let autoColorTimer=null;

/* ===== Helpers ===== */
const $ = s=>document.querySelector(s);
function fmt(n){return Number(n).toFixed(2)}
function rad2deg(r){return r*180/Math.PI}
function deg2rad(d){return d*Math.PI/180}

/* ===== Resize (no reinicia) ===== */
function sizeFromContainer(){
  const rect = cvs.parentElement.getBoundingClientRect();
  return {w: Math.max(1, Math.floor(rect.width*dpi)), h: Math.max(1, Math.floor(rect.height*dpi))};
}
let lastSize = {w:0,h:0};
function resize(){
  const s = sizeFromContainer();
  const dw=Math.abs(s.w-lastSize.w), dh=Math.abs(s.h-lastSize.h);
  if(dw<1 && dh<8) return; // ignora peque√±os cambios (barra de iOS)
  lastSize=s; W=s.w; H=s.h; cvs.width=W; cvs.height=H;
}
resize();
addEventListener('resize', ()=>{ resize(); /* no rebuild */ }, {passive:true});

/* ===== Figuras ===== */
function resamplePolyline(verts, N, close=true){
  const P=verts.slice(); if(close) P.push(verts[0]);
  const L=[0]; let sum=0;
  for(let i=1;i<P.length;i++){ sum+=Math.hypot(P[i][0]-P[i-1][0], P[i][1]-P[i-1][1]); L.push(sum); }
  const out=[];
  for(let i=0;i<N;i++){
    const d=i/N*sum; let j=1; while(j<L.length && L[j]<d) j++;
    const t=(d-L[j-1])/(L[j]-L[j-1]||1);
    out.push({x:P[j-1][0]*(1-t)+P[j][0]*t, y:P[j-1][1]*(1-t)+P[j][1]*t});
  }
  return out;
}
function sampleRegularPolygon(sides,N){
  const R=Math.min(W,H)*0.35, cx=W/2, cy=H/2, V=[];
  for(let i=0;i<sides;i++){ const a=-Math.PI/2 + i*2*Math.PI/sides; V.push([cx+R*Math.cos(a), cy+R*Math.sin(a)]); }
  return resamplePolyline(V,N,true);
}
function sampleStar5(N){
  const cx=W/2, cy=H/2, R=Math.min(W,H)*0.35, r=R*0.4, V=[];
  for(let i=0;i<10;i++){
    const a=-Math.PI/2 + i*(2*Math.PI/10);
    V.push([cx+(i%2===0?R:r)*Math.cos(a), cy+(i%2===0?R:r)*Math.sin(a)]);
  }
  return resamplePolyline(V,N,true);
}
function sampleHeart(N){
  const s=Math.min(W,H)*0.03, cx=W/2, cy=H/2, pts=[];
  for(let i=0;i<N;i++){
    const tt=i/N*2*Math.PI;
    const x=16*Math.pow(Math.sin(tt),3);
    const y=13*Math.cos(tt)-5*Math.cos(2*tt)-2*Math.cos(3*tt)-Math.cos(4*tt);
    pts.push({x:cx + x*s, y:cy - y*s});
  }
  return pts;
}
function sampleInfinity(N){
  const a=Math.min(W,H)*0.25, cx=W/2, cy=H/2, pts=[];
  for(let i=0;i<N;i++){
    const tt=i/N*2*Math.PI, d=1+Math.sin(tt)*Math.sin(tt);
    pts.push({x:cx+a*Math.cos(tt)/d, y:cy+a*Math.sin(tt)*Math.cos(tt)/d});
  }
  return pts;
}
function sampleCircle(N){
  const R=Math.min(W,H)*0.35, cx=W/2, cy=H/2, pts=[];
  for(let i=0;i<N;i++){ const a=i/N*2*Math.PI; pts.push({x:cx+R*Math.cos(a), y:cy+R*Math.sin(a)}); }
  return pts;
}
function sampleBatman(N){
  const base=[[-1.00,0.00],[-0.80,0.22],[-0.60,0.10],[-0.50,0.30],[-0.40,0.10],[-0.30,0.22],[-0.20,0.05],[-0.15,0.22],[-0.10,0.10],[-0.07,0.36],[0.00,0.52],
              [0.07,0.36],[0.10,0.10],[0.15,0.22],[0.20,0.05],[0.30,0.22],[0.40,0.10],[0.50,0.30],[0.60,0.10],[0.80,0.22],[1.00,0.00],
              [0.80,-0.22],[0.60,-0.10],[0.50,-0.30],[0.40,-0.10],[0.30,-0.22],[0.20,-0.05],[0.15,-0.26],[0.10,-0.10],[0.00,-0.42],[-0.10,-0.10],[-0.15,-0.26],[-0.20,-0.05],[-0.30,-0.22],[-0.40,-0.10],[-0.50,-0.30],[-0.60,-0.10],[-0.80,-0.22]];
  const s=Math.min(W,H)*0.35, cx=W/2, cy=H/2;
  const V=base.map(([x,y])=>[cx+x*s, cy+y*s]);
  return resamplePolyline(V,N,true);
}

/* ===== DFT ===== */
function dft(points){
  const N=points.length;
  let cx=0,cy=0; for(const p of points){cx+=p.x; cy+=p.y} cx/=N; cy/=N;
  const z=points.map(p=>({re:p.x-cx, im:p.y-cy}));
  const C=[];
  for(let k=-Math.floor(N/2); k<=Math.floor(N/2); k++){
    let re=0, im=0;
    for(let n=0;n<N;n++){
      const ang=-2*Math.PI*k*n/N;
      re += z[n].re*Math.cos(ang) - z[n].im*Math.sin(ang);
      im += z[n].re*Math.sin(ang) + z[n].im*Math.cos(ang);
    }
    re/=N; im/=N;
    C.push({k, amp:Math.hypot(re,im), phase:Math.atan2(im,re), cx, cy});
  }
  return C;
}
function rebuild(){ order=[...coeffs].sort((a,b)=>b.amp-a.amp); }

/* ===== Animaci√≥n ===== */
let circlesN = 8;
let speed = 0.10;
function frame(dt){
  if(running) t += dt*speed;

  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);

  const chosen = order.slice(0, circlesN);

  let x = (coeffs[0]?.cx || W/2) + centerOffset.x;
  let y = (coeffs[0]?.cy || H/2) + centerOffset.y;

  if(showCircles && !onlyLine){
    ctx.lineWidth = 1*dpi; ctx.strokeStyle='rgba(255,255,255,.25)';
    for(const c of chosen){
      const amp = c.amp*zoom;
      const ang = 2*Math.PI*c.k*(t%1)+c.phase;
      const vx = amp*Math.cos(ang), vy = amp*Math.sin(ang);
      ctx.beginPath(); ctx.arc(x,y,amp,0,Math.PI*2); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+vx,y+vy); ctx.stroke();
      x+=vx; y+=vy;
    }
  } else {
    for(const c of chosen){
      const amp = c.amp*zoom;
      const ang = 2*Math.PI*c.k*(t%1)+c.phase;
      x+=amp*Math.cos(ang); y+=amp*Math.sin(ang);
    }
  }

  if(showTrace){
    trace.push({x,y,color:currentColor});
    if(trace.length>traceMax) trace.splice(0, trace.length-traceMax);
    ctx.lineWidth=2*dpi;
    for(let i=1;i<trace.length;i++){
      ctx.strokeStyle=trace[i].color;
      ctx.beginPath(); ctx.moveTo(trace[i-1].x,trace[i-1].y); ctx.lineTo(trace[i].x,trace[i].y); ctx.stroke();
    }
  }

  ctx.fillStyle=currentColor;
  ctx.beginPath(); ctx.arc(x,y,2.5*dpi,0,Math.PI*2); ctx.fill();
}
let last=performance.now();
function loop(now){ const dt=Math.min(0.05,(now-last)/1000); last=now; frame(dt); requestAnimationFrame(loop); }

/* ===== Build inicial ===== */
function build(shape='heart'){
  const N=1024;
  if(shape==='heart') points=sampleHeart(N);
  else if(shape==='star') points=sampleStar5(N);
  else if(shape==='triangle') points=sampleRegularPolygon(3,N);
  else if(shape==='square') points=sampleRegularPolygon(4,N);
  else if(shape==='pentagon') points=sampleRegularPolygon(5,N);
  else if(shape==='hexagon') points=sampleRegularPolygon(6,N);
  else if(shape==='infinity') points=sampleInfinity(N);
  else if(shape==='circle') points=sampleCircle(N);
  else if(shape==='batman') points=sampleBatman(N);
  coeffs=dft(points); rebuild(); t=0; trace.length=0;
}
build('heart'); requestAnimationFrame(loop);

/* ===== Gestos (pinch / pan / double-tap) ===== */
let touchState=null;
cvs.addEventListener('dblclick', resetView);
cvs.addEventListener('touchstart', e=>{
  if(e.touches.length===2){
    const [a,b]=e.touches;
    touchState={
      mode:'pinch', startDist:dist(a,b), startZoom:zoom,
      startCent:centroid(a,b), startOffset:{...centerOffset}
    };
  } else if(e.touches.length===1){
    touchState={mode:'tap', t:performance.now(), x:e.touches[0].clientX, y:e.touches[0].clientY};
  }
},{passive:false});

cvs.addEventListener('touchmove', e=>{
  if(!touchState) return;
  if(touchState.mode==='pinch' && e.touches.length===2){
    const [a,b]=e.touches;
    const d = dist(a,b);
    const c = centroid(a,b);
    const s = d/(touchState.startDist||1);
    zoom = clamp(touchState.startZoom*s, 0.5, 3);
    // pan con dos dedos: trasladamos relativo al centro
    centerOffset.x = touchState.startOffset.x + (c.clientX - touchState.startCent.clientX)*dpi;
    centerOffset.y = touchState.startOffset.y + (c.clientY - touchState.startCent.clientY)*dpi;
  }
  e.preventDefault();
},{passive:false});

cvs.addEventListener('touchend', e=>{
  if(touchState?.mode==='tap'){
    const dt=performance.now()-touchState.t;
    if(dt<200){ /* simple tap ‚Üí nada */ }
  }
  if(e.touches.length===0) touchState=null;
},{passive:true});

function resetView(){ zoom=1; centerOffset={x:0,y:0}; }
function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }
function centroid(a,b){ return {clientX:(a.clientX+b.clientX)/2, clientY:(a.clientY+b.clientY)/2}; }
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}

/* ===== HUD & Controles ===== */
const fab = $('#fab');
const sheet = $('#sheet'); const expanded = $('#expanded'); const moreBtn = $('#moreBtn');
const closeSheet = $('#closeSheet');
const circlesSlider = $('#circles');
const speedSlider = $('#speed');
const zoomSlider = $('#zoom');
const trailSlider = $('#trail');
const showCirclesChk = $('#showCircles');
const showTraceChk = $('#showTrace');
const shapeSel = $('#shape');
const cDec = $('#cDec'), cInc = $('#cInc');
const speedPreset = $('#speedPreset');
const colorNow = $('#colorNow');
const changeColorBtn = $('#changeColor');
const autoColorChk = $('#autoColor');
const palette = $('#palette');
const savePNGBtn = $('#savePNG');

fab.addEventListener('click', ()=>{ running=!running; fab.textContent = running ? '‚ùö‚ùö' : '‚ñ∂Ô∏é'; });

/* hud taps ‚Üí abrir sheet secciones */
$('#hudCircles').addEventListener('click', openSheet);
$('#hudSpeed').addEventListener('click', ()=>{ cycleSpeed(); });
$('#hudTrail').addEventListener('click', ()=>{ showTrace=!showTrace; showTraceChk.checked=showTrace; });
$('#hudColor').addEventListener('click', ()=>{ nextHue(); });

/* sheet expand/collapse */
moreBtn.addEventListener('click', openSheet);
closeSheet.addEventListener('click', collapseSheet);
function openSheet(){ expanded.style.display='block'; sheet.style.height='55vh'; }
function collapseSheet(){ sheet.style.height='92px'; setTimeout(()=>expanded.style.display='none', 180); }

/* drag sheet (simple) */
let dragY=null, baseH=0;
sheet.addEventListener('touchstart', e=>{
  if(e.target.closest('.slider') || e.target.closest('button') || e.target.closest('select')) return;
  dragY = e.touches[0].clientY; baseH = sheet.getBoundingClientRect().height;
},{passive:true});
sheet.addEventListener('touchmove', e=>{
  if(dragY===null) return;
  const dy = dragY - e.touches[0].clientY;
  const h = clamp(baseH + dy, 92, innerHeight*0.8);
  sheet.style.height = h+'px';
},{passive:true});
sheet.addEventListener('touchend', ()=>{ dragY=null; });

/* circles controls */
circlesSlider.addEventListener('input', ()=>{ circlesN = parseInt(circlesSlider.value,10); });
cDec.addEventListener('click', ()=>{ circlesSlider.value=Math.max(1,parseInt(circlesSlider.value)-1); circlesSlider.dispatchEvent(new Event('input')); });
cInc.addEventListener('click', ()=>{ circlesSlider.value=Math.min(16,parseInt(circlesSlider.value)+1); circlesSlider.dispatchEvent(new Event('input')); });

/* speed */
function cycleSpeed(){
  const presets=[0.05,0.10,0.25,0.50];
  const i = presets.indexOf(Number(speed.toFixed(2)));
  speed = presets[(i+1)%presets.length];
  speedSlider.value = speed;
}
speedPreset.addEventListener('click', cycleSpeed);
speedSlider.addEventListener('input', ()=>{ speed=parseFloat(speedSlider.value); });

/* zoom */
zoomSlider.addEventListener('input', ()=>{ zoom=parseFloat(zoomSlider.value); });
$('#recenter').addEventListener('click', resetView);

/* trace */
showTraceChk.addEventListener('change', ()=>{ showTrace=showTraceChk.checked; });
trailSlider.addEventListener('input', ()=>{ traceMax=parseInt(trailSlider.value,10); });

/* show circles */
showCirclesChk.addEventListener('change', ()=>{ showCircles=showCirclesChk.checked; });

/* color & auto */
function nextHue(){
  // cambia suavemente dentro de una paleta HSL pastel
  const m = Math.random()*360|0;
  currentColor = `hsl(${m},100%,85%)`;
}
colorNow.addEventListener('click', nextHue);
changeColorBtn.addEventListener('click', nextHue);
palette.addEventListener('click', e=>{
  const d = e.target.closest('.dot'); if(!d) return;
  currentColor = d.dataset.c;
});
autoColorChk.addEventListener('change', ()=>{
  if(autoColorChk.checked){
    if(autoColorTimer) clearInterval(autoColorTimer);
    autoColorTimer = setInterval(nextHue, 3000);
  } else {
    if(autoColorTimer){ clearInterval(autoColorTimer); autoColorTimer=null; }
  }
});

/* figure */
shapeSel.addEventListener('change', ()=>{ build(shapeSel.value); });

/* save */
savePNGBtn.addEventListener('click', ()=>{
  const url = cvs.toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download='epiciclos.png'; a.click();
});

/* loop time */
</script>
</body>
</html>
